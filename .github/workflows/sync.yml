name: Sync to Frontend

on:
  push:
    branches: [main]
    paths:
      - "locales/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    name: Sync translations to frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout translations
        uses: actions/checkout@v4

      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: owtics/owtics-frontend
          token: ${{ secrets.FRONTEND_SYNC_PAT }}
          path: _frontend

      - name: Copy locale files
        run: |
          for locale_dir in locales/*/; do
            locale=$(basename "$locale_dir")
            target="_frontend/src/shared/i18n/locales/$locale"
            mkdir -p "$target"
            cp "$locale_dir"*.json "$target/"
          done

      - name: Check for changes and create PR
        working-directory: _frontend
        env:
          GH_TOKEN: ${{ secrets.FRONTEND_SYNC_PAT }}
        run: |
          git config user.name "owtics-bot"
          git config user.email "bot@owtics.gg"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to sync"
            exit 0
          fi

          # Detect new locales (directories with JSON but no index.ts barrel)
          NEW_LOCALES=""
          for dir in src/shared/i18n/locales/*/; do
            locale=$(basename "$dir")
            if [ -f "$dir/game.json" ] && [ ! -f "$dir/index.ts" ]; then
              NEW_LOCALES="$NEW_LOCALES \`$locale\`"
            fi
          done

          # Summarize changed files
          CHANGED=$(git diff --cached --name-only | head -20)

          # Close existing open sync PRs to avoid duplicates
          EXISTING=$(gh pr list --head "translations/" --state open --json number --jq '.[].number' 2>/dev/null || true)
          for pr in $EXISTING; do
            gh pr close "$pr" --comment "Superseded by a newer sync." --delete-branch || true
          done

          BRANCH="translations/sync-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "chore: sync community translations

          Source: https://github.com/owtics/translations"

          git push origin "$BRANCH"

          # Build PR body
          {
            echo "Automated sync from [owtics/translations](https://github.com/owtics/translations)."
            echo ""
            echo "### Changed files"
            echo '```'
            echo "$CHANGED"
            echo '```'
            if [ -n "$NEW_LOCALES" ]; then
              echo ""
              echo "### New locale(s) detected:${NEW_LOCALES}"
              echo ""
              echo "Manual steps required before merging:"
              echo ""
              echo "**Frontend (owtics-frontend):**"
              echo "1. Create \`index.ts\` barrel file for each new locale"
              echo "2. Add import to \`locales/index.ts\`"
              echo "3. Update \`config.ts\` with locale metadata (label, flag, alias)"
              echo ""
              echo "**Backend (owtics-api-server):**"
              echo "4. Add to \`LanguageTag\` enum in \`src/shared/language-tags.ts\`"
              echo ""
              echo "**Codegen:**"
              echo "5. Run \`bun run gql-codegen\` in backend"
              echo "6. Run \`bun run codegen\` in frontend (requires backend running)"
            fi
          } > /tmp/pr-body.md

          gh pr create \
            --title "chore: sync community translations" \
            --body-file /tmp/pr-body.md \
            --base master
