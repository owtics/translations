name: Sync to Frontend

on:
  push:
    branches: [main]
    paths:
      - "locales/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    name: Sync translations to frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout translations
        uses: actions/checkout@v4

      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: funcpp/owtics-frontend
          token: ${{ secrets.FRONTEND_SYNC_PAT }}
          path: _frontend

      - name: Copy locale files
        run: |
          for locale_dir in locales/*/; do
            locale=$(basename "$locale_dir")
            target="_frontend/src/shared/i18n/locales/$locale"
            mkdir -p "$target"
            cp "$locale_dir"*.json "$target/"
          done

      - name: Check for changes and create PR
        working-directory: _frontend
        env:
          GH_TOKEN: ${{ secrets.FRONTEND_SYNC_PAT }}
        run: |
          git config user.name "owtics-bot"
          git config user.email "bot@owtics.gg"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to sync"
            exit 0
          fi

          # Detect new locales (directories with JSON but no index.ts barrel)
          NEW_LOCALES=""
          for dir in src/shared/i18n/locales/*/; do
            locale=$(basename "$dir")
            if [ -f "$dir/game.json" ] && [ ! -f "$dir/index.ts" ]; then
              NEW_LOCALES="$NEW_LOCALES \`$locale\`"
            fi
          done

          # Summarize changed files
          CHANGED=$(git diff --cached --name-only | head -20)

          # Close existing open sync PRs to avoid duplicates
          EXISTING=$(gh pr list --head "translations/" --state open --json number --jq '.[].number' 2>/dev/null || true)
          for pr in $EXISTING; do
            gh pr close "$pr" --comment "Superseded by a newer sync." --delete-branch || true
          done

          BRANCH="translations/sync-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "chore: sync community translations

          Source: https://github.com/owtics/translations"

          git push origin "$BRANCH"

          # Build PR body
          BODY="Automated sync from [owtics/translations](https://github.com/owtics/translations).

          ### Changed files
          \`\`\`
          ${CHANGED}
          \`\`\`"

          if [ -n "$NEW_LOCALES" ]; then
            BODY="${BODY}

          ### ⚠️ New locale(s) detected:${NEW_LOCALES}

          Manual steps required before merging:
          1. Create \`index.ts\` barrel file for each new locale
          2. Add import to \`locales/index.ts\`
          3. Update \`config.ts\` with locale metadata (label, flag, alias)"
          fi

          gh pr create \
            --title "chore: sync community translations" \
            --body "$BODY" \
            --base main
