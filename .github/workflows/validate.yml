name: Validate Translations

on:
  pull_request:
    paths:
      - "locales/**"
  push:
    branches: [main]
    paths:
      - "locales/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install --frozen-lockfile

      - name: Run validation
        id: validate
        continue-on-error: true
        run: bun run validate 2>&1 | tee /tmp/validate-output.txt

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/validate-output.txt', 'utf-8').trim();
            const status = '${{ steps.validate.outcome }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const label = status === 'success' ? 'passed' : 'failed';

            const body = [
              `## ${emoji} Translation Validation (${label})`,
              '',
              '```',
              output,
              '```',
              '',
              '<sub>Updated by CI</sub>',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user?.type === 'Bot' && c.body?.includes('Translation Validation')
            );

            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            };

            if (existing) {
              await github.rest.issues.updateComment({ ...params, comment_id: existing.id });
            } else {
              await github.rest.issues.createComment({ ...params, issue_number: context.issue.number });
            }

      - name: Update README status table
        if: github.event_name == 'push' && steps.validate.outcome == 'success'
        run: bun run validate -- --update-readme

      - name: Commit README update
        if: github.event_name == 'push' && steps.validate.outcome == 'success'
        run: |
          git config user.name "owtics-bot"
          git config user.email "bot@owtics.gg"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: update translation status [skip ci]"
            git push
          fi

      - name: Fail if validation errors
        if: steps.validate.outcome == 'failure'
        run: exit 1
